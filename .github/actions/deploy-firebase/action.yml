name: Deploy to Firebase Hosting
description: Deploy build artifacts to Firebase Hosting site (uses Workload Identity)

inputs:
  site:
    description: Firebase site name (easypool-develop, easypool-staging, easypool-30af3)
    required: true
  target:
    description: Firebase target name (develop, staging, live)
    required: true
  project-id:
    description: Firebase project ID
    required: false
    default: easypool-30af3
  build-artifact:
    description: Name of build artifact to download
    required: false
    default: web-build-${{ github.sha }}

outputs:
  deploy-url:
    description: Deployed site URL
    value: ${{ steps.deploy.outputs.url }}

runs:
  using: composite
  steps:
    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.build-artifact }}
        path: build/web

    - name: Verify build artifact
      shell: bash
      run: |
        echo "ğŸ” Verifying downloaded build..."
        if [ ! -f "build/web/index.html" ]; then
          echo "âŒ ERROR: Build artifact missing index.html!"
          ls -la build/web/
          exit 1
        fi
        echo "âœ… Build artifact verified"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache Firebase CLI
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: firebase-cli-${{ runner.os }}-node20
        restore-keys: |
          firebase-cli-${{ runner.os }}-

    - name: Install Firebase CLI
      shell: bash
      run: npm install -g firebase-tools

    - name: Deploy to Firebase Hosting
      id: deploy
      shell: bash
      run: |
        echo "ğŸš€ Deploying to Firebase site: ${{ inputs.site }}"
        echo "ğŸ¯ Target: ${{ inputs.target }}"
        echo "ğŸ“¦ Project: ${{ inputs.project-id }}"
        echo ""

        # Get access token from authenticated gcloud
        ACCESS_TOKEN=$(gcloud auth print-access-token)

        # Deploy to the specific site using target
        firebase deploy \
          --only hosting:${{ inputs.target }} \
          --project ${{ inputs.project-id }} \
          --token "${ACCESS_TOKEN}" \
          --non-interactive

        # Construct URL based on site name
        if [[ "${{ inputs.site }}" == "easypool-30af3" ]]; then
          URL="https://easypool-30af3.web.app"
        else
          URL="https://${{ inputs.site }}.web.app"
        fi

        echo "url=$URL" >> $GITHUB_OUTPUT
        echo ""
        echo "âœ… Deployment successful!"
        echo "ğŸŒ URL: $URL"
