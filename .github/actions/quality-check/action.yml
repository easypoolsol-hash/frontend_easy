name: Quality Checks
description: Run Flutter analyze and format checks

inputs:
  fail-on-warnings:
    description: Fail if analysis warnings are found
    required: false
    default: 'false'

outputs:
  analysis-result:
    description: Analysis result (passed/failed)
    value: ${{ steps.analyze.outcome }}
  format-result:
    description: Format check result (passed/failed)
    value: ${{ steps.format.outcome }}
  openapi-result:
    description: OpenAPI validation result (passed/failed)
    value: ${{ steps.openapi.outcome }}

runs:
  using: composite
  steps:
    - name: Flutter analyze
      id: analyze
      shell: bash
      continue-on-error: ${{ inputs.fail-on-warnings == 'false' }}
      run: |
        echo "ðŸ” Running Flutter analyze..."
        flutter analyze --no-fatal-infos
        ANALYZE_EXIT=$?

        if [ $ANALYZE_EXIT -eq 0 ]; then
          echo "âœ… Analysis passed - no issues found"
        else
          echo "âš ï¸ Analysis found issues"
        fi

        exit $ANALYZE_EXIT

    - name: Check Dart formatting
      id: format
      shell: bash
      continue-on-error: true
      run: |
        echo "ðŸŽ¨ Checking Dart formatting..."
        dart format --set-exit-if-changed --output none .
        FORMAT_EXIT=$?

        if [ $FORMAT_EXIT -eq 0 ]; then
          echo "âœ… Format check passed - code is properly formatted"
        else
          echo "âš ï¸ Format check failed - code needs formatting"
          echo ""
          echo "To fix, run: dart format ."
        fi

        exit $FORMAT_EXIT

    - name: Validate OpenAPI
      id: openapi
      shell: bash
      continue-on-error: false
      run: |
        echo "ðŸ”Œ Validating OpenAPI schema..."

        # Check if schema file exists
        if [ ! -f "openapi-schema.yaml" ]; then
          echo "âŒ ERROR: openapi-schema.yaml not found"
          exit 1
        fi

        # Validate YAML syntax
        echo "ðŸ“‹ Checking YAML syntax..."
        if ! python3 -c "import yaml; yaml.safe_load(open('openapi-schema.yaml'))" 2>/dev/null; then
          echo "âŒ ERROR: Invalid YAML syntax in openapi-schema.yaml"
          exit 1
        fi
        echo "âœ… YAML syntax valid"

        # Check for ListList naming issues
        echo "ðŸ”Ž Checking for ListList naming issues..."
        if grep -r "ListList" packages/frontend_easy_api/lib/src/model/ 2>/dev/null; then
          echo "âŒ ERROR: Found 'ListList' in generated models - schema hook not applied!"
          echo "This indicates the OpenAPI schema needs regeneration with proper hooks."
          exit 1
        fi
        echo "âœ… No ListList naming issues found"

        # Verify critical generated files exist
        echo "ðŸ“¦ Verifying generated API files..."
        REQUIRED_FILES=(
          "packages/frontend_easy_api/lib/src/api/api_api.dart"
          "packages/frontend_easy_api/lib/src/serializers.dart"
          "packages/frontend_easy_api/lib/frontend_easy_api.dart"
        )

        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ERROR: Required file missing: $file"
            echo "Run 'make generate' to regenerate API code"
            exit 1
          fi
        done
        echo "âœ… All required API files present"

        echo ""
        echo "âœ… OpenAPI validation passed"

    - name: Quality summary
      shell: bash
      if: always()
      run: |
        echo "## ðŸ“Š Quality Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.analyze.outcome }}" == "success" ]]; then
          echo "- âœ… **Analysis**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ **Analysis**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.format.outcome }}" == "success" ]]; then
          echo "- âœ… **Format**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ **Format**: Failed (run \`dart format .\`)" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.openapi.outcome }}" == "success" ]]; then
          echo "- âœ… **OpenAPI**: Valid schema and generated code" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **OpenAPI**: Validation failed (see [OPENAPI_WORKFLOW.md](../OPENAPI_WORKFLOW.md))" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
