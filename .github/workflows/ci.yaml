name: CI Pipeline

on:
  push:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  pull_request:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (quality + build only)'
        required: false
        type: boolean
        default: false
      deploy_target:
        description: 'Force deployment target (overrides branch detection)'
        required: false
        type: choice
        options:
          - auto
          - develop
          - production
          - skip
        default: auto

permissions:
  contents: read
  checks: write

env:
  FLUTTER_VERSION: '3.35.6'  # Includes Dart 3.9.2 (required: SDK >=3.9.0)
  FIREBASE_PROJECT_ID: easypool-30af3

jobs:
  # ============================================================================
  # STAGE 0: PATH INDICATOR (Shows which deployment path will be taken)
  # ============================================================================
  show-path:
    name: üó∫Ô∏è Deployment Path
    runs-on: ubuntu-latest
    steps:
      - name: Display deployment path
        run: |
          echo "================================================"
          echo "üó∫Ô∏è  CI/CD DEPLOYMENT PATH"
          echo "================================================"
          echo ""
          echo "üìã Event: ${{ github.event_name }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üíº Actor: ${{ github.actor }}"
          echo ""

          if [[ "${{ github.event.inputs.skip_deploy }}" == "true" || "${{ github.event.inputs.deploy_target }}" == "skip" ]]; then
            echo "üö´ DEPLOYMENT: SKIPPED (manual override)"
            echo "   ‚îú‚îÄ Quality checks: ‚úÖ Will run"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: ‚ùå Skipped"
          elif [[ "${{ github.event.inputs.deploy_target }}" == "develop" ]]; then
            echo "üéØ DEPLOYMENT TARGET: Firebase Develop Channel (manual)"
            echo "   ‚îú‚îÄ Quality checks: ‚úÖ Will run"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: üü° develop channel"
          elif [[ "${{ github.event.inputs.deploy_target }}" == "production" ]]; then
            echo "üéØ DEPLOYMENT TARGET: Firebase Production (manual)"
            echo "   ‚îú‚îÄ Quality checks: ‚úÖ Will run"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: üî¥ live (production)"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "üîç PULL REQUEST MODE"
            echo "   ‚îú‚îÄ Quality checks: ‚ö†Ô∏è Optional (won't block build)"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: ‚ùå No deployment"
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            echo "üéØ DEPLOYMENT TARGET: Firebase Develop Channel"
            echo "   ‚îú‚îÄ Quality checks: ‚ö†Ô∏è Optional (won't block build)"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: üü° develop channel"
            echo ""
            echo "üåê Preview URL: https://easypool-30af3--develop-XXXXX.web.app"
          elif [[ "${{ github.ref_name }}" == "master" || "${{ github.ref_name }}" == "main" ]]; then
            echo "üéØ DEPLOYMENT TARGET: Firebase Production"
            echo "   ‚îú‚îÄ Quality checks: ‚ö†Ô∏è Optional (won't block build)"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: üî¥ live (production)"
            echo ""
            echo "üåê Production URL: https://easypool-30af3.web.app"
            echo "‚ö†Ô∏è  Note: Redirects to Vercel for live users"
          else
            echo "‚ùì UNKNOWN PATH"
            echo "   ‚îú‚îÄ Quality checks: ‚ö†Ô∏è Optional (won't block build)"
            echo "   ‚îú‚îÄ Build: ‚úÖ Will run"
            echo "   ‚îî‚îÄ Deploy: ‚ùå No deployment"
          fi
          echo ""
          echo "================================================"

  # ============================================================================
  # STAGE 1: QUALITY CHECKS (Optional - Won't Block Build)
  # ============================================================================
  quality:
    name: ‚ö†Ô∏è Quality Checks (Optional)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      # Verify pre-generated API client exists (created by backend hook)
      - name: Verify pre-generated API client
        run: |
          if [ ! -d packages/frontend_easy_api ]; then
            echo "ERROR: packages/frontend_easy_api not found!"
            echo "Run backend pre-commit hook: git commit in backend_easy"
            exit 1
          fi
          if [ ! -f packages/frontend_easy_api/lib/src/model/user.g.dart ]; then
            echo "ERROR: .g.dart files missing!"
            echo "Run backend pre-commit hook to regenerate"
            exit 1
          fi
          echo "‚úÖ Pre-generated API client verified"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # Cache Flutter pub dependencies
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: flutter-pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Check formatting
        run: dart format --set-exit-if-changed .

  # ============================================================================
  # STAGE 2: BUILD & TEST (Independent of Quality Checks)
  # ============================================================================
  build:
    name: Build Flutter Web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # Cache Flutter pub dependencies
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: flutter-pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      # Cache Flutter build
      - name: Cache Flutter build
        uses: actions/cache@v4
        with:
          path: |
            build/
            .flutter-plugins-dependencies
          key: flutter-build-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', 'lib/**', 'web/**', 'assets/**') }}
          restore-keys: |
            flutter-build-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-

      - name: Build web (release)
        run: flutter build web --release

      # Upload build artifacts for deployment jobs
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 1

  # ============================================================================
  # STAGE 3: DEPLOY TO DEVELOP CHANNEL (Firebase Hosting)
  # ============================================================================
  deploy-develop:
    name: üü° Deploy to Develop
    runs-on: ubuntu-latest
    needs: build
    # Deploy to develop if:
    # - Branch is develop AND event is push (automatic)
    # - OR manual trigger with deploy_target=develop
    # - AND skip_deploy is NOT true
    if: |
      github.event.inputs.skip_deploy != 'true' && (
        (github.ref == 'refs/heads/develop' && github.event_name == 'push' && github.event.inputs.deploy_target != 'production' && github.event.inputs.deploy_target != 'skip') ||
        github.event.inputs.deploy_target == 'develop'
      )
    environment:
      name: develop
      url: https://easypool-30af3--develop-CHANNEL_ID.web.app
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-node20
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure Firebase targets
        run: |
          firebase target:apply hosting develop easypool-30af3
          firebase target:apply hosting live easypool-30af3

      - name: Setup Firebase Authentication
        run: |
          echo ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }} > service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=service-account.json

      - name: üöÄ Deploy to Firebase Hosting (develop target)
        run: firebase deploy --only hosting:develop --project ${{ env.FIREBASE_PROJECT_ID }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account.json

      - name: ‚úÖ Deployment Success
        run: |
          echo "================================================"
          echo "‚úÖ SUCCESSFULLY DEPLOYED TO DEVELOP"
          echo "================================================"
          echo "üåê Preview URL will be shown above"
          echo "üéØ Channel: develop"
          echo "üì¶ Project: ${{ env.FIREBASE_PROJECT_ID }}"
          echo "================================================"

  # ============================================================================
  # STAGE 4: DEPLOY TO PRODUCTION (Firebase Hosting Live)
  # ============================================================================
  deploy-production:
    name: üî¥ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    # Deploy to production if:
    # - Branch is master/main AND event is push (automatic)
    # - OR manual trigger with deploy_target=production
    # - AND skip_deploy is NOT true
    if: |
      github.event.inputs.skip_deploy != 'true' && (
        ((github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && github.event_name == 'push' && github.event.inputs.deploy_target != 'develop' && github.event.inputs.deploy_target != 'skip') ||
        github.event.inputs.deploy_target == 'production'
      )
    environment:
      name: production
      url: https://easypool-30af3.web.app
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-node20
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure Firebase targets
        run: |
          firebase target:apply hosting develop easypool-30af3
          firebase target:apply hosting live easypool-30af3

      - name: Setup Firebase Authentication
        run: |
          echo ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }} > service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=service-account.json

      - name: üöÄ Deploy to Firebase Hosting (live target)
        run: firebase deploy --only hosting:live --project ${{ env.FIREBASE_PROJECT_ID }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account.json

      - name: ‚úÖ Production Deployment Success
        run: |
          echo "================================================"
          echo "‚úÖ SUCCESSFULLY DEPLOYED TO PRODUCTION"
          echo "================================================"
          echo "üåê Production URL: https://easypool-30af3.web.app"
          echo "‚ö†Ô∏è  Note: Redirects to Vercel (live users protected)"
          echo "üéØ Channel: live"
          echo "üì¶ Project: ${{ env.FIREBASE_PROJECT_ID }}"
          echo "================================================"
