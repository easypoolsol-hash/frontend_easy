name: CI Pipeline

on:
  push:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  pull_request:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (quality + build only)'
        required: false
        type: boolean
        default: false
      deploy_target:
        description: 'Force deployment target (overrides branch detection)'
        required: false
        type: choice
        options:
          - auto
          - develop
          - production
          - skip
        default: auto

permissions:
  contents: read
  checks: write

env:
  FLUTTER_VERSION: '3.35.6'  # Includes Dart 3.9.2 (required: SDK >=3.9.0)
  FIREBASE_PROJECT_ID: easypool-30af3

jobs:
  # ============================================================================
  # STAGE 0: PATH INDICATOR (Shows which deployment path will be taken)
  # ============================================================================
  show-path:
    name: ğŸ—ºï¸ Deployment Path
    runs-on: ubuntu-latest
    steps:
      - name: Display deployment path
        run: |
          echo "================================================"
          echo "ğŸ—ºï¸  CI/CD DEPLOYMENT PATH"
          echo "================================================"
          echo ""
          echo "ğŸ“‹ Event: ${{ github.event_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ’¼ Actor: ${{ github.actor }}"
          echo ""

          if [[ "${{ github.event.inputs.skip_deploy }}" == "true" || "${{ github.event.inputs.deploy_target }}" == "skip" ]]; then
            echo "ğŸš« DEPLOYMENT: SKIPPED (manual override)"
            echo "   â”œâ”€ Quality checks: âœ… Will run"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: âŒ Skipped"
          elif [[ "${{ github.event.inputs.deploy_target }}" == "develop" ]]; then
            echo "ğŸ¯ DEPLOYMENT TARGET: Firebase Develop Channel (manual)"
            echo "   â”œâ”€ Quality checks: âœ… Will run"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: ğŸŸ¡ develop channel"
          elif [[ "${{ github.event.inputs.deploy_target }}" == "production" ]]; then
            echo "ğŸ¯ DEPLOYMENT TARGET: Firebase Production (manual)"
            echo "   â”œâ”€ Quality checks: âœ… Will run"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: ğŸ”´ live (production)"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ğŸ” PULL REQUEST MODE"
            echo "   â”œâ”€ Quality checks: âš ï¸ Optional (won't block build)"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: âŒ No deployment"
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            echo "ğŸ¯ DEPLOYMENT TARGET: Firebase Develop Channel"
            echo "   â”œâ”€ Quality checks: âš ï¸ Optional (won't block build)"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: ğŸŸ¡ develop channel"
            echo ""
            echo "ğŸŒ Preview URL: https://easypool-30af3--develop-XXXXX.web.app"
          elif [[ "${{ github.ref_name }}" == "master" || "${{ github.ref_name }}" == "main" ]]; then
            echo "ğŸ¯ DEPLOYMENT TARGET: Firebase Production"
            echo "   â”œâ”€ Quality checks: âš ï¸ Optional (won't block build)"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: ğŸ”´ live (production)"
            echo ""
            echo "ğŸŒ Production URL: https://easypool-30af3.web.app"
            echo "âš ï¸  Note: Redirects to Vercel for live users"
          else
            echo "â“ UNKNOWN PATH"
            echo "   â”œâ”€ Quality checks: âš ï¸ Optional (won't block build)"
            echo "   â”œâ”€ Build: âœ… Will run"
            echo "   â””â”€ Deploy: âŒ No deployment"
          fi
          echo ""
          echo "================================================"

  # ============================================================================
  # STAGE 1: QUALITY CHECKS (Optional - Won't Block Build)
  # ============================================================================
  quality:
    name: âš ï¸ Quality Checks (Optional)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      # Verify pre-generated API client exists (created by backend hook)
      - name: Verify pre-generated API client
        run: |
          if [ ! -d packages/frontend_easy_api ]; then
            echo "ERROR: packages/frontend_easy_api not found!"
            echo "Run backend pre-commit hook: git commit in backend_easy"
            exit 1
          fi
          if [ ! -f packages/frontend_easy_api/lib/src/model/user.g.dart ]; then
            echo "ERROR: .g.dart files missing!"
            echo "Run backend pre-commit hook to regenerate"
            exit 1
          fi
          echo "âœ… Pre-generated API client verified"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # Cache Flutter pub dependencies
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: flutter-pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Check formatting
        run: dart format --set-exit-if-changed .

  # ============================================================================
  # STAGE 2: BUILD & TEST (Independent of Quality Checks)
  # ============================================================================
  build:
    name: Build Flutter Web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # Cache Flutter pub dependencies
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: flutter-pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      # Cache Flutter build
      - name: Cache Flutter build
        uses: actions/cache@v4
        with:
          path: |
            build/
            .flutter-plugins-dependencies
          key: flutter-build-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', 'lib/**', 'web/**', 'assets/**') }}
          restore-keys: |
            flutter-build-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-

      - name: Build web (release)
        run: flutter build web --release

      # Upload build artifacts for deployment jobs
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 1

  # ============================================================================
  # STAGE 3: DEPLOY TO DEVELOP CHANNEL (Firebase Hosting)
  # ============================================================================
  deploy-develop:
    name: ğŸŸ¡ Deploy to Develop
    runs-on: ubuntu-latest
    needs: build
    # Deploy to develop if:
    # - Branch is develop AND event is push (automatic)
    # - OR manual trigger with deploy_target=develop
    # - AND skip_deploy is NOT true
    if: |
      github.event.inputs.skip_deploy != 'true' && (
        (github.ref == 'refs/heads/develop' && github.event_name == 'push' && github.event.inputs.deploy_target != 'production' && github.event.inputs.deploy_target != 'skip') ||
        github.event.inputs.deploy_target == 'develop'
      )
    environment:
      name: develop
      url: https://easypool-30af3--develop-CHANNEL_ID.web.app
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-node18
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure Firebase targets
        run: |
          firebase target:apply hosting develop easypool-30af3
          firebase target:apply hosting live easypool-30af3

      - name: ğŸš€ Deploy to Firebase Hosting (develop channel)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          channelId: develop
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
          entryPoint: "/github/workspace"

      - name: âœ… Deployment Success
        run: |
          echo "================================================"
          echo "âœ… SUCCESSFULLY DEPLOYED TO DEVELOP"
          echo "================================================"
          echo "ğŸŒ Preview URL will be shown above"
          echo "ğŸ¯ Channel: develop"
          echo "ğŸ“¦ Project: ${{ env.FIREBASE_PROJECT_ID }}"
          echo "================================================"

  # ============================================================================
  # STAGE 4: DEPLOY TO PRODUCTION (Firebase Hosting Live)
  # ============================================================================
  deploy-production:
    name: ğŸ”´ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    # Deploy to production if:
    # - Branch is master/main AND event is push (automatic)
    # - OR manual trigger with deploy_target=production
    # - AND skip_deploy is NOT true
    if: |
      github.event.inputs.skip_deploy != 'true' && (
        ((github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && github.event_name == 'push' && github.event.inputs.deploy_target != 'develop' && github.event.inputs.deploy_target != 'skip') ||
        github.event.inputs.deploy_target == 'production'
      )
    environment:
      name: production
      url: https://easypool-30af3.web.app
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: firebase-cli-${{ runner.os }}-node18
          restore-keys: |
            firebase-cli-${{ runner.os }}-

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure Firebase targets
        run: |
          firebase target:apply hosting develop easypool-30af3
          firebase target:apply hosting live easypool-30af3

      - name: ğŸš€ Deploy to Firebase Hosting (live)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          channelId: live
          projectId: ${{ env.FIREBASE_PROJECT_ID }}
          entryPoint: "/github/workspace"

      - name: âœ… Production Deployment Success
        run: |
          echo "================================================"
          echo "âœ… SUCCESSFULLY DEPLOYED TO PRODUCTION"
          echo "================================================"
          echo "ğŸŒ Production URL: https://easypool-30af3.web.app"
          echo "âš ï¸  Note: Redirects to Vercel (live users protected)"
          echo "ğŸ¯ Channel: live"
          echo "ğŸ“¦ Project: ${{ env.FIREBASE_PROJECT_ID }}"
          echo "================================================"
