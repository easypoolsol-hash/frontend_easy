name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'doc_new/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  pull_request:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'doc_new/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'

permissions:
  contents: read
  checks: write

env:
  FIREBASE_PROJECT_ID: easypool-30af3

jobs:
  # ============================================================================
  # DECISION HEAD: Route to correct deployment path
  # ============================================================================
  # develop â†’ deploy to easypool-develop (dev.easypool.in)
  # master  â†’ deploy to easypool-staging (stage.easypool.in)
  # v* tag  â†’ deploy to easypool-30af3 (easypool.in)
  # PR      â†’ validate only (no deploy)
  # ============================================================================
  decide:
    name: ğŸ¯ Decide deployment path
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.route.outputs.should_deploy }}
      deploy_develop: ${{ steps.route.outputs.deploy_develop }}
      deploy_staging: ${{ steps.route.outputs.deploy_staging }}
      deploy_production: ${{ steps.route.outputs.deploy_production }}
      require_quality: ${{ steps.route.outputs.require_quality }}
    steps:
      - name: Route workflow
        id: route
        run: |
          echo "# ğŸ¯ Workflow Routing Decision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize outputs
          SHOULD_DEPLOY=false
          DEPLOY_DEVELOP=false
          DEPLOY_STAGING=false
          DEPLOY_PRODUCTION=false
          REQUIRE_QUALITY=false

          # PR: validate only
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "## ğŸ” PULL REQUEST MODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Quality checks (REQUIRED)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Build validation" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ No deployment" >> $GITHUB_STEP_SUMMARY

            SHOULD_DEPLOY=false
            REQUIRE_QUALITY=true

          # develop branch: deploy to develop site
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "## ğŸŸ¡ DEVELOP PATH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¯ Target: easypool-develop site" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ URL: https://dev.easypool.in" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”Œ Backend: staging" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quality:** âš ï¸ Optional (won't block deployment)" >> $GITHUB_STEP_SUMMARY

            SHOULD_DEPLOY=true
            DEPLOY_DEVELOP=true
            REQUIRE_QUALITY=false

          # master branch: deploy to staging site
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "## ğŸŸ  STAGING PATH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¯ Target: easypool-staging site" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ URL: https://stage.easypool.in" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”Œ Backend: candidate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quality:** âš ï¸ Optional (won't block deployment)" >> $GITHUB_STEP_SUMMARY

            SHOULD_DEPLOY=true
            DEPLOY_STAGING=true
            REQUIRE_QUALITY=false

          # v* tag: deploy to production
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "## ğŸ”´ PRODUCTION PATH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¯ Target: easypool-30af3 site (live)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ URL: https://easypool.in" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”Œ Backend: production" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ·ï¸ Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quality:** âœ… REQUIRED" >> $GITHUB_STEP_SUMMARY

            SHOULD_DEPLOY=true
            DEPLOY_PRODUCTION=true
            REQUIRE_QUALITY=true

          else
            echo "## â“ UNKNOWN PATH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No deployment will occur." >> $GITHUB_STEP_SUMMARY

            SHOULD_DEPLOY=false
            REQUIRE_QUALITY=false
          fi

          # Set outputs
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "deploy_develop=$DEPLOY_DEVELOP" >> $GITHUB_OUTPUT
          echo "deploy_staging=$DEPLOY_STAGING" >> $GITHUB_OUTPUT
          echo "deploy_production=$DEPLOY_PRODUCTION" >> $GITHUB_OUTPUT
          echo "require_quality=$REQUIRE_QUALITY" >> $GITHUB_OUTPUT

  # ============================================================================
  # DEVELOP BRANCH: Quality â†’ Build â†’ Deploy to Develop
  # ============================================================================

  quality-develop:
    name: ğŸŸ¡ Quality (Develop)
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.deploy_develop == 'true'
    continue-on-error: true  # Won't block deployment
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/quality-check
        with:
          fail-on-warnings: 'false'

  build-develop:
    name: ğŸŸ¡ Build (Develop)
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.deploy_develop == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/build-web

  deploy-develop:
    name: ğŸŸ¡ Deploy to Develop
    runs-on: ubuntu-latest
    needs: [decide, build-develop]
    if: needs.decide.outputs.deploy_develop == 'true'
    environment:
      name: develop
      url: https://dev.easypool.in
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/deploy-firebase
        with:
          site: easypool-develop
          target: develop
          firebase-token: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          project-id: ${{ env.FIREBASE_PROJECT_ID }}
          build-artifact: web-build-${{ github.sha }}

      - name: âœ… Deployment success
        run: |
          echo "# ğŸŸ¡ DEVELOP DEPLOYMENT SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** easypool-develop" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://dev.easypool.in" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** staging (runtime detection)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGING BRANCH: Quality â†’ Build â†’ Deploy to Staging
  # ============================================================================

  quality-staging:
    name: ğŸŸ  Quality (Staging)
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.deploy_staging == 'true'
    continue-on-error: true  # Won't block deployment
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/quality-check
        with:
          fail-on-warnings: 'false'

  build-staging:
    name: ğŸŸ  Build (Staging)
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.deploy_staging == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/build-web

  deploy-staging:
    name: ğŸŸ  Deploy to Staging
    runs-on: ubuntu-latest
    needs: [decide, build-staging]
    if: needs.decide.outputs.deploy_staging == 'true'
    environment:
      name: staging
      url: https://stage.easypool.in
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/deploy-firebase
        with:
          site: easypool-staging
          target: staging
          firebase-token: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          project-id: ${{ env.FIREBASE_PROJECT_ID }}
          build-artifact: web-build-${{ github.sha }}

      - name: âœ… Deployment success
        run: |
          echo "# ğŸŸ  STAGING DEPLOYMENT SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** easypool-staging" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://stage.easypool.in" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** candidate (runtime detection)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # PRODUCTION BRANCH: Quality (REQUIRED) â†’ Build â†’ Deploy to Production
  # ============================================================================

  quality-production:
    name: ğŸ”´ Quality (Production - REQUIRED)
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.deploy_production == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/quality-check
        with:
          fail-on-warnings: 'true'

  build-production:
    name: ğŸ”´ Build (Production)
    runs-on: ubuntu-latest
    needs: [decide, quality-production]
    if: needs.decide.outputs.deploy_production == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/build-web

  deploy-production:
    name: ğŸ”´ Deploy to Production
    runs-on: ubuntu-latest
    needs: [decide, build-production]
    if: needs.decide.outputs.deploy_production == 'true'
    environment:
      name: production
      url: https://easypool.in
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/deploy-firebase
        with:
          site: easypool-30af3
          target: live
          firebase-token: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          project-id: ${{ env.FIREBASE_PROJECT_ID }}
          build-artifact: web-build-${{ github.sha }}

      - name: âœ… Production deployment success
        run: |
          echo "# ğŸ”´ PRODUCTION DEPLOYMENT SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** easypool-30af3 (live)" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://easypool.in" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** production (runtime detection)" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **Production release complete!**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # PR VALIDATION: Quality (REQUIRED) â†’ Build (No Deploy)
  # ============================================================================

  quality-pr:
    name: ğŸ” Quality (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/quality-check
        with:
          fail-on-warnings: 'true'

  build-pr:
    name: ğŸ” Build (PR - Validate Only)
    runs-on: ubuntu-latest
    needs: [quality-pr]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/build-web
