name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'doc_new/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'
  pull_request:
    branches: [ master, main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'doc_new/**'
      - '.vscode/**'
      - '.idea/**'
      - 'LICENSE'

permissions:
  contents: read
  checks: write

env:
  FIREBASE_PROJECT_ID: easypool-30af3

jobs:
  # ============================================================================
  # DECISION HEAD: Route to correct deployment path
  # ============================================================================
  decide:
    name: ðŸŽ¯ Decide
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.route.outputs.should_deploy }}
      deploy_develop: ${{ steps.route.outputs.deploy_develop }}
      deploy_staging: ${{ steps.route.outputs.deploy_staging }}
      deploy_production: ${{ steps.route.outputs.deploy_production }}
      path_name: ${{ steps.route.outputs.path_name }}
      path_emoji: ${{ steps.route.outputs.path_emoji }}
      path_url: ${{ steps.route.outputs.path_url }}
    steps:
      - name: Route workflow
        id: route
        run: |
          echo "# ðŸŽ¯ Routing Decision" >> $GITHUB_STEP_SUMMARY

          # Initialize
          SHOULD_DEPLOY=false
          DEPLOY_DEVELOP=false
          DEPLOY_STAGING=false
          DEPLOY_PRODUCTION=false
          PATH_NAME=""
          PATH_EMOJI=""
          PATH_URL=""

          # PR: validate only
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "## ðŸ” PR VALIDATION" >> $GITHUB_STEP_SUMMARY
            SHOULD_DEPLOY=false
            PATH_NAME="PR"
            PATH_EMOJI="ðŸ”"
            PATH_URL="(no deployment)"

          # develop: deploy to develop site
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "## ðŸŸ¡ DEVELOP â†’ dev.easypool.in" >> $GITHUB_STEP_SUMMARY
            SHOULD_DEPLOY=true
            DEPLOY_DEVELOP=true
            PATH_NAME="DEVELOP"
            PATH_EMOJI="ðŸŸ¡"
            PATH_URL="dev.easypool.in"

          # master: deploy to staging site
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "## ðŸŸ  STAGING â†’ stage.easypool.in" >> $GITHUB_STEP_SUMMARY
            SHOULD_DEPLOY=true
            DEPLOY_STAGING=true
            PATH_NAME="STAGING"
            PATH_EMOJI="ðŸŸ "
            PATH_URL="stage.easypool.in"

          # v* tag: deploy to production
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "## ðŸ”´ PRODUCTION â†’ easypool.in" >> $GITHUB_STEP_SUMMARY
            SHOULD_DEPLOY=true
            DEPLOY_PRODUCTION=true
            PATH_NAME="PRODUCTION"
            PATH_EMOJI="ðŸ”´"
            PATH_URL="easypool.in"
          fi

          # Set outputs
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "deploy_develop=$DEPLOY_DEVELOP" >> $GITHUB_OUTPUT
          echo "deploy_staging=$DEPLOY_STAGING" >> $GITHUB_OUTPUT
          echo "deploy_production=$DEPLOY_PRODUCTION" >> $GITHUB_OUTPUT
          echo "path_name=$PATH_NAME" >> $GITHUB_OUTPUT
          echo "path_emoji=$PATH_EMOJI" >> $GITHUB_OUTPUT
          echo "path_url=$PATH_URL" >> $GITHUB_OUTPUT

  # ============================================================================
  # PATH INDICATOR: Single job showing active path
  # ============================================================================
  path:
    name: ${{ needs.decide.outputs.path_emoji }} ${{ needs.decide.outputs.path_name }} PATH
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.path_name != ''
    steps:
      - run: echo "âœ… Deploying to ${{ needs.decide.outputs.path_url }}"

  # ============================================================================
  # QUALITY: Non-blocking quality checks
  # ============================================================================
  quality:
    name: âš¡ Quality
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.should_deploy == 'true' || github.event_name == 'pull_request'
    continue-on-error: true  # Won't block build/deploy
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/quality-check
        with:
          fail-on-warnings: 'false'

  # ============================================================================
  # BUILD: Single build job
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [decide]
    if: needs.decide.outputs.should_deploy == 'true' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-flutter
      - uses: ./.github/actions/build-web

  # ============================================================================
  # DEPLOY: Matrix strategy for all environments
  # ============================================================================
  deploy:
    name: ${{ matrix.emoji }} Deploy to ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: [decide, build]
    if: needs.decide.outputs.should_deploy == 'true'
    strategy:
      matrix:
        include:
          - env: develop
            name: Develop
            emoji: ðŸŸ¡
            site: easypool-develop
            target: develop
            url: https://dev.easypool.in
            condition: deploy_develop
          - env: staging
            name: Staging
            emoji: ðŸŸ 
            site: easypool-staging
            target: staging
            url: https://stage.easypool.in
            condition: deploy_staging
          - env: production
            name: Production
            emoji: ðŸ”´
            site: easypool-30af3
            target: live
            url: https://easypool.in
            condition: deploy_production
    environment:
      name: ${{ matrix.env }}
      url: ${{ matrix.url }}
    steps:
      - name: Check if should deploy
        id: should_deploy
        run: |
          DEPLOY=false
          if [[ "${{ matrix.env }}" == "develop" && "${{ needs.decide.outputs.deploy_develop }}" == "true" ]]; then
            DEPLOY=true
          elif [[ "${{ matrix.env }}" == "staging" && "${{ needs.decide.outputs.deploy_staging }}" == "true" ]]; then
            DEPLOY=true
          elif [[ "${{ matrix.env }}" == "production" && "${{ needs.decide.outputs.deploy_production }}" == "true" ]]; then
            DEPLOY=true
          fi
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.should_deploy.outputs.deploy == 'true'

      - uses: ./.github/actions/deploy-firebase
        if: steps.should_deploy.outputs.deploy == 'true'
        with:
          site: ${{ matrix.site }}
          target: ${{ matrix.target }}
          firebase-token: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EASYPOOL_30AF3 }}
          project-id: ${{ env.FIREBASE_PROJECT_ID }}
          build-artifact: web-build-${{ github.sha }}

      - name: Success
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          echo "# ${{ matrix.emoji }} ${{ matrix.name }} DEPLOYED" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ matrix.url }}" >> $GITHUB_STEP_SUMMARY
